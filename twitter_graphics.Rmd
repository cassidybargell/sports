---
title: "twitter graphics"
author: "Cassidy Bargell"
date: "4/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rtweet)
library(httpuv)
library(gtrendsR)
library(lubridate)
library(maps)
library(pals)
library(viridis)
library(scico)
library(ggrepel)
library(infer)
library(tidyr)
library(stringr)
library(tidytext)
library(widyr)
data("stop_words")
```

```{r read in}

# read in RDS files to work with to avoid rate limits on twitter

football <- readRDS("sport-perceptions/raw-data/football.RDS")
rugby <- readRDS("sport-perceptions/raw-data/rugby.RDS")
nfl_tml <- readRDS("sport-perceptions/raw-data/nfl_tml.RDS")
wr_tml <- readRDS("sport-perceptions/raw-data/wr_tml.RDS")
sr_tml <- readRDS("sport-perceptions/raw-data/sr_tml.RDS")
usarugby_tml <- readRDS("sport-perceptions/raw-data/usarugby_tml.RDS")
usahockey_tml <- readRDS("sport-perceptions/raw-data/usahockey_tml.RDS")
ussoccer_tml <- readRDS("sport-perceptions/raw-data/ussoccer_tml.RDS")
hockey <- readRDS("sport-perceptions/raw-data/hockey.RDS")
soccer <- readRDS("sport-perceptions/raw-data/soccer.RDS")
```

```{r nfl_tml words}

# Remove urls in tweets, and create list of words I want to search the tweets
# for. Capitalization are recognized separately.

words <- c("Concussion", "concussion", "CTE", "cte", "head", "Head", "Injury", "injury")
unique(words)

nfl_tml$stripped_text <- gsub("http.*","",  nfl_tml$text)
nfl_tml$stripped_text <- gsub("https.*","", nfl_tml$stripped_text)

nfl_tml_clean <- nfl_tml %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) 

# Get rid of pre-loaded group of words that have no context

nfl_tml_clean <- nfl_tml_clean %>%
  anti_join(stop_words, by = "word")
```

```{r football tweet words}
football %>%
  select(created_at, text, favorite_count, quote_count, retweet_count, reply_count) 

# Remove urls in tweets, and create list of words I want to search the tweets
# for. Capitalization are recognized separately.

football$stripped_text <- gsub("http.*","",  football$text)
football$stripped_text <- gsub("https.*","", football$stripped_text)

nfl_tml_clean <- nfl_tml %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) 

# Get rid of pre-loaded group of words that have no context

nfl_tml_clean <- nfl_tml_clean %>%
  anti_join(stop_words, by = "word")
```

```{r cleaning function}

# Create function for cleaning the tweet words based on what I did above

tweetclean <- function(tib) {

tib$stripped_text <- gsub("http.*","",  tib$text)
tib$stripped_text <- gsub("https.*","", tib$stripped_text)

tib_clean <- tib %>%
  select(stripped_text) %>%
  unnest_tokens(word, stripped_text) 

tib_clean <- tib_clean %>%
  anti_join(stop_words, by = "word")
}

# Only want to use a sample of 4,000 of the tweets, as there are generally less
# rugby tweets than football in the US, so a random sample of most recent 4,000
# in the tibbles scrapped will then be used and bootstrap resampled.

football <- football %>%
  slice(1:4000)

rugby <- rugby %>%
  slice(1:4000)

football_clean <- tweetclean(football)
sr_clean <- tweetclean(sr_tml)
wr_clean <- tweetclean(wr_tml)
rugby_clean <- tweetclean(rugby)
usarugby_tml_clean <- tweetclean(usarugby_tml)
usahockey_tml_clean <- tweetclean(usahockey_tml)
ussoccer_tml_clean <- tweetclean(ussoccer_tml)
hockey_clean <- tweetclean(hockey)
soccer_clean <- tweetclean(soccer)
```

```{r paired words}

# Search for paired words like head-injury. Don't know if I will use this for
# anything.

football_paired_words <- football %>%
  select(stripped_text) %>%
  unnest_tokens(paired_words, stripped_text, token = "ngrams", n = 2)

football_paired_words %>%
  count(paired_words, sort = TRUE)

football_separated_words <- football_paired_words %>%
  separate(paired_words, c("word1", "word2"), sep = " ")

football_filtered <- football_separated_words %>%
  filter(!word1 %in% stop_words$word) %>%
  filter(!word2 %in% stop_words$word)

# new bigram counts:

football_words_counts <- football_filtered %>%
  count(word1, word2, sort = TRUE)
```

```{r}

# Try to find proportions of cleaned tweets, can then bootstrap resample. 

football_prop <- football_clean %>%
  count(contains_word = (word == "concussion" | word == "concussions" | word == "cte" | word == "injury" |  word == "injuries")) %>%
  mutate(total = sum(n)) %>%
  filter(contains_word == 'TRUE') %>%
  mutate(prop = (n / total) * 100)

# Make function to make that process easier. The final proportion is in
# percentage.

proportion_words <- function(tib){
  tib %>%
  count(contains_word = (word == "concussion" | word == "concussions" | word == "cte" | word == "injury" |  word == "injuries")) %>%
  mutate(total = sum(n)) %>%
  filter(contains_word == 'TRUE') %>%
  mutate(prop = (n / total) * 100)
}

rugby_prop <- proportion_words(rugby_clean)
sr_prop <- proportion_words(sr_clean)
wr_prop <- proportion_words(wr_clean)
nfl_prop <- proportion_words(nfl_tml_clean)
usarugby_prop <- proportion_words(usarugby_tml_clean) 
usahockey_prop <- proportion_words(usahockey_tml_clean)
ussoccer_prop <- proportion_words(ussoccer_tml_clean)
hockey_prop <- proportion_words(hockey_clean)
soccer_prop <- proportion_words(soccer_clean)
```

```{r bootstrap resample, cache = TRUE}

# Bootstrap re-sample the football data

bootstrap_football <- football %>%
  rep_sample_n(size = 4000, replace = TRUE, reps = 1000) %>%
  tweetclean() %>%
  group_by(replicate) %>%
  proportion_words() %>%
  ungroup() %>%
  pull(prop) %>%
  quantile(c(0.025, 0.975))

file.create("bootstrap_football.RDS")
saveRDS(bootstrap_football, file = "sport-perceptions/raw-data/bootstrap_football.RDS")

# Create function to bootstrap the words more easily

bootstrap_prop <- function(tib){
  tib %>%
  rep_sample_n(size = 4000, replace = TRUE, reps = 1000) %>%
  tweetclean() %>%
  group_by(replicate) %>%
  proportion_words() %>%
  ungroup() %>%
  pull(prop) %>%
  quantile(c(0.025, 0.975))
}

# Bootstrap resample all of the different sources

bootstrap_rugby <- bootstrap_prop(rugby)
bootstrap_sr <- bootstrap_prop(sr_tml)
bootstrap_wr <- bootstrap_prop(wr_tml)
bootstrap_nfl <- bootstrap_prop(nfl_tml)
bootstrap_usarugby <- bootstrap_prop(usarugby_tml)
bootstrap_usahockey <- bootstrap_prop(usahockey_tml)
bootstrap_ussoccer <- bootstrap_prop(ussoccer_tml)
bootstrap_soccer <- bootstrap_prop(soccer)
bootstrap_hockey <- bootstrap_prop(hockey)

file.create("bootstrap_rugby.RDS")
saveRDS(bootstrap_rugby, file = "sport-perceptions/raw-data/bootstrap_rugby.RDS")

file.create("bootstrap_sr.RDS")
saveRDS(bootstrap_sr, file = "sport-perceptions/raw-data/bootstrap_sr.RDS")

file.create("bootstrap_wr.RDS")
saveRDS(bootstrap_wr, file = "sport-perceptions/raw-data/bootstrap_wr.RDS")

file.create("bootstrap_nfl.RDS")
saveRDS(bootstrap_nfl, file = "sport-perceptions/raw-data/bootstrap_nfl.RDS")

file.create("bootstrap_usarugby.RDS")
saveRDS(bootstrap_usarugby, file = "sport-perceptions/raw-data/bootstrap_usarugby.RDS")

file.create("bootstrap_usahockey.RDS")
saveRDS(bootstrap_usahockey, file = "sport-perceptions/raw-data/bootstrap_usahockey.RDS")

file.create("bootstrap_ussoccer.RDS")
saveRDS(bootstrap_ussoccer, file = "sport-perceptions/raw-data/bootstrap_ussoccer.RDS")

file.create("bootstrap_soccer.RDS")
saveRDS(bootstrap_soccer, file = "sport-perceptions/raw-data/bootstrap_soccer.RDS")

file.create("bootstrap_hockey.RDS")
saveRDS(bootstrap_hockey, file = "sport-perceptions/raw-data/bootstrap_hockey.RDS")
```


